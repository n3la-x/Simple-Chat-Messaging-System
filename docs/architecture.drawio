<mxfile host="app.diagrams.net">
  <diagram name="Architecture">
    <mxGraphModel dx="1200" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Client -->
        <mxCell id="client" value="Client (Browser)&#10;index.html&#10;- fetch (REST)&#10;- socket.io (WS)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="220" width="210" height="120" as="geometry"/>
        </mxCell>

        <!-- API Gateway -->
        <mxCell id="gateway" value="API Gateway :4000&#10;- REST endpoints (/api/*)&#10;- Socket.IO server&#10;- JWT verify (auth + role)&#10;- Proxy to services" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="330" y="200" width="260" height="160" as="geometry"/>
        </mxCell>

        <!-- User Service -->
        <mxCell id="user" value="User Service :4001&#10;- Register/Login&#10;- SQLite users.db&#10;- JWT sign&#10;- Admin endpoints (internal only)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="670" y="90" width="270" height="150" as="geometry"/>
        </mxCell>

        <!-- Message Service -->
        <mxCell id="message" value="Message Service :4002&#10;- Save messages&#10;- SQLite messages.db&#10;- Kafka Producer&#10;Topic: chat.messages" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="670" y="270" width="270" height="150" as="geometry"/>
        </mxCell>

        <!-- Analytics Service -->
        <mxCell id="analytics" value="Analytics Service :4003&#10;- Kafka Consumer&#10;- Calculates stats&#10;GET /stats" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="670" y="450" width="270" height="140" as="geometry"/>
        </mxCell>

        <!-- Kafka -->
        <mxCell id="kafka" value="Kafka Broker :9092&#10;Topic: chat.messages" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1020" y="330" width="210" height="110" as="geometry"/>
        </mxCell>

        <!-- Zookeeper -->
        <mxCell id="zookeeper" value="Zookeeper :2181" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="1020" y="210" width="210" height="80" as="geometry"/>
        </mxCell>

        <!-- Docker Compose -->
        <mxCell id="compose" value="Docker Compose&#10;- starts all services&#10;- internal network (DNS: service names)&#10;- env vars (JWT_SECRET, INTERNAL_API_KEY)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#eeeeee;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="330" y="410" width="260" height="140" as="geometry"/>
        </mxCell>

        <!-- Edges: Client -> Gateway -->
        <mxCell id="e1" value="HTTP (REST) + WebSocket" style="endArrow=block;html=1;strokeWidth=2;" edge="1" parent="1" source="client" target="gateway">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Edges: Gateway -> User -->
        <mxCell id="e2" value="REST proxy&#10;/api/auth/*" style="endArrow=block;html=1;strokeWidth=2;" edge="1" parent="1" source="gateway" target="user">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Edges: Gateway -> Message -->
        <mxCell id="e3" value="REST + Socket events&#10;/messages" style="endArrow=block;html=1;strokeWidth=2;" edge="1" parent="1" source="gateway" target="message">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Edges: Gateway -> Analytics -->
        <mxCell id="e4" value="REST proxy&#10;/api/stats" style="endArrow=block;html=1;strokeWidth=2;" edge="1" parent="1" source="gateway" target="analytics">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Edge: Message -> Kafka -->
        <mxCell id="e5" value="Publish event&#10;MessageSent" style="endArrow=block;html=1;strokeWidth=2;dashed=1;" edge="1" parent="1" source="message" target="kafka">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Edge: Kafka -> Analytics -->
        <mxCell id="e6" value="Consume event&#10;update stats" style="endArrow=block;html=1;strokeWidth=2;dashed=1;" edge="1" parent="1" source="kafka" target="analytics">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Edge: Kafka <-> Zookeeper -->
        <mxCell id="e7" value="coordination" style="endArrow=block;html=1;strokeWidth=2;" edge="1" parent="1" source="zookeeper" target="kafka">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Notes: Zero Trust -->
        <mxCell id="note" value="Security notes&#10;• JWT: user/admin role in token&#10;• Admin routes: requireAuth + requireAdmin&#10;• Service-to-service: x-internal-key (Zero Trust)&#10;• External entrypoint: API Gateway only" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="60" width="530" height="120" as="geometry"/>
        </mxCell>

        <!-- Edge: Compose to services (visual) -->
        <mxCell id="c1" value="runs" style="endArrow=block;html=1;dashed=1;strokeWidth=1;" edge="1" parent="1" source="compose" target="gateway">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="c2" value="runs" style="endArrow=block;html=1;dashed=1;strokeWidth=1;" edge="1" parent="1" source="compose" target="user">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="c3" value="runs" style="endArrow=block;html=1;dashed=1;strokeWidth=1;" edge="1" parent="1" source="compose" target="message">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="c4" value="runs" style="endArrow=block;html=1;dashed=1;strokeWidth=1;" edge="1" parent="1" source="compose" target="analytics">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="c5" value="runs" style="endArrow=block;html=1;dashed=1;strokeWidth=1;" edge="1" parent="1" source="compose" target="kafka">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="c6" value="runs" style="endArrow=block;html=1;dashed=1;strokeWidth=1;" edge="1" parent="1" source="compose" target="zookeeper">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
