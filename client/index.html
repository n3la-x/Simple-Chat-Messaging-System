<!doctype html>
<html>
<head><meta charset="utf-8" /><title>Chat</title></head>
<body>
  <h3>Chat</h3>

  <div>
    <input id="u" placeholder="username">
    <input id="p" placeholder="password" type="password">
    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>
  </div>

  <hr />

  <div>
    <input id="m" placeholder="message" />
    <button onclick="sendMsg()">Send</button>
  </div>

  <pre id="log"></pre>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
  const log = (x) => document.getElementById("log").textContent += x + "\n";
  let token = null;
  let socket = null;

  async function register(){
    const username = u.value;
    const password = p.value;

    if(password.length < 6){
      alert("Password must be at least 6 characters");
      return;
    }

    const r = await fetch("http://localhost:4000/api/auth/register", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ username, email: username+"@test.com", password })
    });

    const data = await r.json();
    log("register: " + JSON.stringify(data));
  }

  async function login(){
    const username = u.value, password = p.value;

    const r = await fetch("http://localhost:4000/api/auth/login", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ username, password })
    });

    const data = await r.json();
    token = data.token;

    if(!token){
      log("login failed");
      return;
    }

    log("login OK");

    // connect socket with JWT
    socket = io("http://localhost:4000", { auth: { token } });
    socket.on("connect", ()=>log("socket connected"));
    socket.on("message:new", (msg)=>log(`[${msg.senderUsername}] ${msg.content}`));

    // load history
    loadMessages();
    loadStats();
  }

  async function loadMessages(){
    const r = await fetch("http://localhost:4000/api/messages");
    const data = await r.json();
    log("---- history ----");
    data.reverse().forEach(m => {
      log(`[${m.senderUsername}] ${m.content}`);
    });
    log("-----------------");
  }

  async function loadStats(){
    const r = await fetch("http://localhost:4000/api/stats");
    const data = await r.json();
    log("Total messages: " + data.totalMessages);
  }

  function sendMsg(){
    if (!socket) return;
    socket.emit("message:send", { content: m.value });
    m.value = "";

    // refresh stats after send
    setTimeout(loadStats, 500);
  }


  </script>
</body>
</html>
